#!/usr/bin/env ruby

$LOAD_PATH.push File.expand_path('../../lib', __FILE__)

require 'exportation'

require 'rubygems'
require 'commander'

class ExportationApplication
  include Commander::Methods

  def run
    program :name, 'Exportation'
    program :version, '0.1.0'
    program :description, 'CLI tool of easy exporting, encrypting, and decrypting of certificates and private keys.'

    command :export do |c|
      c.syntax = 'exportation export [options]'
      c.description = 'Exports certificate and private key from Keychain Access'
      c.option '--path STRING', String, 'Path to save certificate and private key'
      c.option '--filename STRING', String, 'File name to save certificate and private key as'
      c.option '--name STRING', String, 'Common name of the cert as it is displayed in Keychain Access'
      c.option '--password STRING', String, 'Password to use for the private key'
      c.action do |args, options|
        options.default path: "./", filename:"exported", password: ""

        raise "--name is required" unless options.name

        Exportation::Export.new(
          path: options.path,
          filename: options.filename,
          name: options.name,
          password: options.name
        ).run

      end
    end

    command :encrypt do |c|
      c.syntax = 'exportation encrypt [options]'
      c.description = 'Encrypts certificates, private keys, and provisioning profiles with SSL'
      c.option '--password STRING', String, 'Password to use for the encryption'
      c.option '--output STRING', String, 'Output directory for files (defaults to where original files are located)'
      c.action do |args, options|
        options.default output: nil

        raise "--password is required" unless options.password

        Exportation::Encrypt.new(
          files: args,
          password: options.password,
          output: options.output
        ).run

      end
    end

    run!
  end
end

ExportationApplication.new.run if $0 == __FILE__
